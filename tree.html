<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <!-- ç¦æ­¢ç¼©æ”¾ï¼Œé€‚é…å…¨å± -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI åœ£è¯æ ‘</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

    <style>
        body { margin: 0; overflow: hidden; background-color: #000; }
        
        /* è§†é¢‘å±‚ï¼šåœ¨ iOS ä¸Šå¿…é¡»å¯è§æ‰èƒ½è¿è¡Œï¼Œè®¾ä¸ºåº•å±‚ */
        .input_video {
            position: absolute;
            top: 0; left: 0;
            width: 1px; height: 1px;
            opacity: 0;
            z-index: -1;
        }

        #canvas-container {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: 1;
        }

        #ui-layer {
            position: absolute;
            top: 20px; left: 0;
            width: 100%;
            text-align: center;
            z-index: 10;
            pointer-events: none;
        }

        #greeting-text {
            font-family: 'Brush Script MT', cursive;
            font-size: 3rem;
            color: #ffd700;
            text-shadow: 0 0 10px #ff0000, 0 0 20px #ff0000;
            animation: glow 2s infinite alternate;
        }

        @keyframes glow {
            from { text-shadow: 0 0 10px #ff0000, 0 0 20px #ff0000; }
            to { text-shadow: 0 0 20px #ff0000, 0 0 30px #ff4500; }
        }

        #loading {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 1.2rem;
            z-index: 20;
            background: rgba(0,0,0,0.7);
            padding: 20px;
            border-radius: 10px;
            display: none;
        }

        /* å¯åŠ¨é®ç½©å±‚ (iOS å¿…é¡») */
        #start-screen {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 100;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            color: white;
        }
        #start-btn {
            padding: 15px 40px;
            font-size: 1.2rem;
            background: #d42f2f;
            color: white;
            border: none;
            border-radius: 30px;
            margin-top: 20px;
            cursor: pointer;
            box-shadow: 0 0 15px rgba(212, 47, 47, 0.5);
        }
    </style>
</head>
<body>
    <!-- å¯åŠ¨å±å¹• -->
    <div id="start-screen">
        <h1>ğŸ„ AI åœ£è¯æ ‘</h1>
        <p>å‡†å¤‡å¥½ä½ çš„æ‰‹åŠ¿äº†å—ï¼Ÿ</p>
        <button id="start-btn">ç‚¹å‡»å¼€å§‹ä½“éªŒ</button>
        <p style="margin-top:15px; color:#aaa; font-size:0.8rem;">(iOS ç”¨æˆ·è¯·å…è®¸æ‘„åƒå¤´æƒé™)</p>
    </div>

    <div id="loading">æ­£åœ¨åŠ è½½ AI æ¨¡å‹...</div>

    <div id="ui-layer">
        <div id="greeting-text">Merry Christmas</div>
    </div>

    <!-- å…³é”®ï¼šplaysinline å±æ€§ç”¨äº iOS Safari -->
    <video class="input_video" playsinline webkit-playsinline></video>
    <div id="canvas-container"></div>

    <script>
        // --- 1. è¯»å–é…ç½® ---
        const greeting = localStorage.getItem('xmas_greeting');
        if (greeting) document.getElementById('greeting-text').innerText = greeting;
        
        const photoData = localStorage.getItem('xmas_photo');
        let userTexture = null;
        if (photoData) {
            userTexture = new THREE.TextureLoader().load(photoData);
        }

        // --- 2. Three.js åœºæ™¯è®¾ç½® ---
        const container = document.getElementById('canvas-container');
        const scene = new THREE.Scene();
        scene.fog = new THREE.FogExp2(0x000000, 0.002);

        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.z = 5;

        const renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        container.appendChild(renderer.domElement);

        // --- 3. åˆ›å»ºåœ£è¯æ ‘ ---
        const treeGroup = new THREE.Group();
        scene.add(treeGroup);

        // æ ‘å¶
        const geometry = new THREE.ConeGeometry(1, 3, 32);
        const material = new THREE.MeshStandardMaterial({ 
            color: 0x0f5f13, 
            roughness: 0.4,
            metalness: 0.1
        });
        const treeMesh = new THREE.Mesh(geometry, material);
        treeMesh.position.y = 0.5;
        treeGroup.add(treeMesh);

        // è£…é¥°å“
        const particlesGeometry = new THREE.BufferGeometry();
        const particleCount = 100;
        const posArray = new Float32Array(particleCount * 3);
        const colorsArray = new Float32Array(particleCount * 3);

        for(let i = 0; i < particleCount * 3; i+=3) {
            const t = Math.random() * 3;
            const angle = Math.random() * Math.PI * 2;
            const radius = (3 - t) * 0.4;
            
            posArray[i] = Math.cos(angle) * radius;
            posArray[i+1] = t - 1;
            posArray[i+2] = Math.sin(angle) * radius;

            const color = new THREE.Color();
            color.setHSL(Math.random(), 1.0, 0.5);
            colorsArray[i] = color.r;
            colorsArray[i+1] = color.g;
            colorsArray[i+2] = color.b;
        }

        particlesGeometry.setAttribute('position', new THREE.BufferAttribute(posArray, 3));
        particlesGeometry.setAttribute('color', new THREE.BufferAttribute(colorsArray, 3));

        const particlesMaterial = new THREE.PointsMaterial({
            size: 0.1,
            vertexColors: true,
            blending: THREE.AdditiveBlending
        });
        const ornaments = new THREE.Points(particlesGeometry, particlesMaterial);
        treeGroup.add(ornaments);

        // ç”¨æˆ·ç…§ç‰‡
        if (userTexture) {
            const photoGeo = new THREE.CircleGeometry(0.4, 32);
            const photoMat = new THREE.MeshBasicMaterial({ map: userTexture, side: THREE.DoubleSide });
            const photoMesh = new THREE.Mesh(photoGeo, photoMat);
            photoMesh.position.y = 2.2;
            photoMesh.position.z = 0.1;
            treeGroup.add(photoMesh);
        } else {
            const starGeo = new THREE.IcosahedronGeometry(0.3, 0);
            const starMat = new THREE.MeshBasicMaterial({ color: 0xffff00 });
            const starMesh = new THREE.Mesh(starGeo, starMat);
            starMesh.position.y = 2.2;
            treeGroup.add(starMesh);
        }

        // ç¯å…‰
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
        scene.add(ambientLight);
        const pointLight = new THREE.PointLight(0xffffff, 1);
        pointLight.position.set(5, 5, 5);
        scene.add(pointLight);

        // é›ªèŠ±
        const snowGeo = new THREE.BufferGeometry();
        const snowCount = 500;
        const snowPos = new Float32Array(snowCount * 3);
        for(let i=0; i<snowCount*3; i++) {
            snowPos[i] = (Math.random() - 0.5) * 20;
        }
        snowGeo.setAttribute('position', new THREE.BufferAttribute(snowPos, 3));
        const snowMat = new THREE.PointsMaterial({
            color: 0xffffff,
            size: 0.1,
            transparent: true
        });
        const snowSystem = new THREE.Points(snowGeo, snowMat);
        scene.add(snowSystem);

        // --- 4. åŠ¨ç”»å¾ªç¯ ---
        function animate() {
            requestAnimationFrame(animate);
            treeGroup.rotation.y += 0.005;
            
            const positions = snowSystem.geometry.attributes.position.array;
            for(let i=1; i<snowCount*3; i+=3) {
                positions[i] -= 0.05;
                if (positions[i] < -5) positions[i] = 5;
            }
            snowSystem.geometry.attributes.position.needsUpdate = true;

            renderer.render(scene, camera);
        }
        animate();

        // --- 5. MediaPipe æ‰‹åŠ¿è¯†åˆ« ---
        const videoElement = document.getElementsByClassName('input_video')[0];
        
        function onResults(results) {
            document.getElementById('loading').style.display = 'none';
            
            if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                const landmarks = results.multiHandLandmarks[0];
                const indexTip = landmarks[8];
                const thumbTip = landmarks[4];

                const x = (0.5 - indexTip.x) * 10;
                const y = (0.5 - indexTip.y) * 10;
                
                treeGroup.position.x += (x - treeGroup.position.x) * 0.1;
                treeGroup.position.y += (y - treeGroup.position.y) * 0.1;

                const distance = Math.sqrt(
                    Math.pow(indexTip.x - thumbTip.x, 2) + 
                    Math.pow(indexTip.y - thumbTip.y, 2)
                );
                const scale = 1 + distance * 3;
                treeGroup.scale.set(scale, scale, scale);
            }
        }

        const hands = new Hands({locateFile: (file) => {
            return `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`;
        }});
        
        hands.setOptions({
            maxNumHands: 1,
            modelComplexity: 1,
            minDetectionConfidence: 0.5,
            minTrackingConfidence: 0.5
        });
        
        hands.onResults(onResults);

        const cameraUtils = new Camera(videoElement, {
            onFrame: async () => {
                await hands.send({image: videoElement});
            },
            width: 640,
            height: 480
        });

        // --- 6. å¯åŠ¨é€»è¾‘ (é€‚é… iOS) ---
        document.getElementById('start-btn').addEventListener('click', function() {
            const startScreen = document.getElementById('start-screen');
            const loading = document.getElementById('loading');
            
            startScreen.style.display = 'none';
            loading.style.display = 'block';
            
            videoElement.play().catch(e => console.log("Video play handled by Camera utils"));

            cameraUtils.start().then(() => {
                console.log("Camera started");
            }).catch(err => {
                console.error("Camera error:", err);
                alert("æ— æ³•å¯åŠ¨æ‘„åƒå¤´ã€‚è¯·åœ¨è®¾ç½®ä¸­å…è®¸ Safari è®¿é—®æ‘„åƒå¤´ï¼Œå¹¶åˆ·æ–°é¡µé¢é‡è¯•ã€‚");
                startScreen.style.display = 'flex';
                loading.style.display = 'none';
            });
        });

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>
</html>