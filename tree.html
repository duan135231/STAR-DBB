<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>AI Christmas Tree</title>
    <!-- å¼•å…¥ Google Fonts æå‡è´¨æ„Ÿ -->
    <link href="https://fonts.googleapis.com/css2?family=Mountains+of+Christmas:wght@700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
    <style>
        body { 
            margin: 0; 
            overflow: hidden; 
            background-color: #000; 
            font-family: 'Mountains of Christmas', cursive; /* ä½¿ç”¨è‰ºæœ¯å­—ä½“ */
        }
        
        /* è§†é¢‘å±‚ï¼šåœ¨ iPad ä¸Šæˆ‘ä»¬é€šå¸¸å¸Œæœ›éšè—å®ƒï¼Œæˆ–è€…åšå¾—å¾ˆå°ï¼Œåªçœ‹ Canvas æ•ˆæœ */
        .input_video { 
            position: absolute; 
            top: 10px; 
            left: 10px; 
            width: 120px; /* ç¼©å°è§†é¢‘é¢„è§ˆ */
            height: 90px;
            z-index: 10; 
            border-radius: 10px;
            opacity: 0.7;
            transform: scaleX(-1); /* é•œåƒç¿»è½¬ */
            display: none; /* é»˜è®¤éšè—ï¼Œå¦‚æœæƒ³çœ‹æ‘„åƒå¤´ç”»é¢å¯ä»¥æ”¹ä¸º block */
        }

        #canvas-container { 
            width: 100vw; 
            height: 100vh; 
            position: absolute; 
            top: 0; 
            left: 0; 
            z-index: 1;
        }

        #ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 5;
            pointer-events: none; /* è®©ç‚¹å‡»ç©¿é€åˆ° Canvas */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
        }

        #greeting-text {
            margin-top: 10vh;
            font-size: 3rem;
            color: #fff;
            text-shadow: 0 0 10px #ff0000, 0 0 20px #ff0000, 0 0 30px #ff0000;
            animation: glow 2s ease-in-out infinite alternate;
            text-align: center;
            width: 90%;
        }

        #user-photo {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            border: 3px solid gold;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
            margin-top: 20px;
            object-fit: cover;
            display: none; /* é»˜è®¤éšè—ï¼Œæœ‰å›¾æ‰æ˜¾ç¤º */
        }

        @keyframes glow {
            from { text-shadow: 0 0 10px #fff, 0 0 20px #fff, 0 0 30px #e60073; }
            to { text-shadow: 0 0 20px #fff, 0 0 30px #ff4da6, 0 0 40px #ff4da6; }
        }

        /* åŠ è½½æç¤º */
        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 1.5rem;
            z-index: 20;
        }

        /* iOS å¯åŠ¨é®ç½© */
        #start-screen {
            position: absolute; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0,0,0,0.95); 
            z-index: 100; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            flex-direction: column; 
            color: white;
        }
        
        #start-btn {
            padding: 15px 50px; 
            font-size: 1.5rem; 
            background: linear-gradient(to right, #d42f2f, #ff6b6b); 
            color: white; 
            border: none; 
            border-radius: 50px; 
            margin-top: 30px; 
            cursor: pointer;
            box-shadow: 0 0 20px rgba(212, 47, 47, 0.5);
            font-family: 'Mountains of Christmas', cursive;
        }
    </style>
</head>
<body>
    <!-- å¯åŠ¨é¡µ -->
    <div id="start-screen">
        <h1 style="font-size: 3rem; margin-bottom: 0;">ğŸ„ AI Christmas Tree</h1>
        <p style="color: #aaa;">Move your hand to rotate the tree</p>
        <button id="start-btn">Start Magic</button>
    </div>

    <div id="loading" style="display:none;">Loading Magic...</div>

    <!-- UI å±‚ -->
    <div id="ui-layer">
        <div id="greeting-text">Merry Christmas</div>
        <img id="user-photo" alt="User Photo">
    </div>

    <!-- è§†é¢‘è¾“å…¥ (éšè—æˆ–ç¼©å°) -->
    <video class="input_video" playsinline webkit-playsinline></video>
    
    <!-- 3D å®¹å™¨ -->
    <div id="canvas-container"></div>

    <script>
        // --- 1. è¯»å–é…ç½® ---
        const greeting = localStorage.getItem('xmas_greeting');
        if (greeting) {
            document.getElementById('greeting-text').innerText = greeting;
        }
        
        const photoData = localStorage.getItem('xmas_photo');
        if (photoData) {
            const img = document.getElementById('user-photo');
            img.src = photoData;
            img.style.display = 'block';
        }

        // --- 2. Three.js åœºæ™¯è®¾ç½® ---
        const scene = new THREE.Scene();
        // æ·»åŠ ä¸€ç‚¹é›¾æ•ˆï¼Œå¢åŠ æ·±é‚ƒæ„Ÿ
        scene.fog = new THREE.FogExp2(0x000000, 0.0008);

        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true }); // å¼€å¯æŠ—é”¯é½¿
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio); // é€‚é…é«˜æ¸…å±
        document.getElementById('canvas-container').appendChild(renderer.domElement);

        // --- 3. åˆ›å»ºæ›´æ¼‚äº®çš„ç²’å­åœ£è¯æ ‘ ---
        const particlesGeometry = new THREE.BufferGeometry();
        const particlesCount = 3000; // å¢åŠ ç²’å­æ•°é‡
        
        const posArray = new Float32Array(particlesCount * 3);
        const colorArray = new Float32Array(particlesCount * 3); // ç²’å­é¢œè‰²

        for(let i = 0; i < particlesCount; i++) {
            // èºæ—‹å½¢çŠ¶ç®—æ³•
            const angle = Math.random() * Math.PI * 2 * 10; // ç»•åœˆ
            const radius = Math.random() * 3 * (1 - i / particlesCount); // ä¸‹é¢å®½ä¸Šé¢çª„
            const y = (i / particlesCount) * 8 - 4; // é«˜åº¦åˆ†å¸ƒ
            
            // åŠ ä¸Šä¸€äº›éšæœºæŠ–åŠ¨ï¼Œè®©æ ‘çœ‹èµ·æ¥æ›´è‡ªç„¶
            const x = Math.cos(angle) * radius + (Math.random() - 0.5) * 0.5;
            const z = Math.sin(angle) * radius + (Math.random() - 0.5) * 0.5;

            posArray[i * 3] = x;
            posArray[i * 3 + 1] = y;
            posArray[i * 3 + 2] = z;

            // é¢œè‰²ï¼šç»¿è‰²ä¸ºä¸»ï¼Œæ··å…¥çº¢è‰²å’Œé‡‘è‰²
            const colorType = Math.random();
            if (colorType > 0.9) {
                // é‡‘è‰²/é»„è‰² (ç¯å…‰)
                colorArray[i * 3] = 1.0;
                colorArray[i * 3 + 1] = 0.8;
                colorArray[i * 3 + 2] = 0.2;
            } else if (colorType > 0.8) {
                // çº¢è‰² (è£…é¥°)
                colorArray[i * 3] = 1.0;
                colorArray[i * 3 + 1] = 0.1;
                colorArray[i * 3 + 2] = 0.1;
            } else {
                // ç»¿è‰² (æ ‘å¶)
                colorArray[i * 3] = 0.1;
                colorArray[i * 3 + 1] = 0.8 + Math.random() * 0.2;
                colorArray[i * 3 + 2] = 0.2;
            }
        }

        particlesGeometry.setAttribute('position', new THREE.BufferAttribute(posArray, 3));
        particlesGeometry.setAttribute('color', new THREE.BufferAttribute(colorArray, 3));

        // ä½¿ç”¨ç‚¹æè´¨
        const material = new THREE.PointsMaterial({
            size: 0.08,
            vertexColors: true, // å¯ç”¨é¡¶ç‚¹é¢œè‰²
            blending: THREE.AdditiveBlending, // å‘å…‰æ•ˆæœ
            transparent: true,
            opacity: 0.8
        });

        const tree = new THREE.Points(particlesGeometry, material);
        scene.add(tree);

        // æ·»åŠ é¡¶éƒ¨æ˜Ÿæ˜Ÿ
        const starGeometry = new THREE.SphereGeometry(0.2, 8, 8);
        const starMaterial = new THREE.MeshBasicMaterial({ color: 0xffff00 });
        const star = new THREE.Mesh(starGeometry, starMaterial);
        star.position.y = 4.2;
        scene.add(star);

        // æ·»åŠ ç‚¹å…‰æºç…§äº®æ˜Ÿæ˜Ÿ
        const pointLight = new THREE.PointLight(0xffaa00, 1, 10);
        pointLight.position.set(0, 4, 0);
        scene.add(pointLight);

        camera.position.z = 7;
        camera.position.y = 0;

        // --- 4. åŠ¨ç”»å¾ªç¯ ---
        let targetRotationY = 0;
        let targetRotationX = 0;

        function animate() {
            requestAnimationFrame(animate);

            // å¹³æ»‘æ—‹è½¬
            tree.rotation.y += (targetRotationY - tree.rotation.y) * 0.1;
            tree.rotation.x += (targetRotationX - tree.rotation.x) * 0.1;
            
            // è‡ªåŠ¨ç¼“æ…¢è‡ªè½¬
            tree.rotation.y += 0.002;

            // æ˜Ÿæ˜Ÿé—ªçƒ
            const time = Date.now() * 0.005;
            star.scale.setScalar(1 + Math.sin(time) * 0.2);

            renderer.render(scene, camera);
        }
        animate();

        // --- 5. MediaPipe æ‰‹åŠ¿è¯†åˆ« ---
        const videoElement = document.getElementsByClassName('input_video')[0];
        
        function onResults(results) {
            document.getElementById('loading').style.display = 'none';
            
            if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                const landmarks = results.multiHandLandmarks[0];
                
                // è·å–é£ŸæŒ‡æŒ‡å°– (ç´¢å¼• 8) çš„åæ ‡
                const indexFingerTip = landmarks[8];
                
                // æ˜ å°„åæ ‡åˆ°æ—‹è½¬è§’åº¦
                // x: 0~1 -> -PI ~ PI
                const x = (indexFingerTip.x - 0.5) * 2; 
                const y = (indexFingerTip.y - 0.5) * 2;

                targetRotationY = x * 3; // å·¦å³æ—‹è½¬å¹…åº¦
                targetRotationX = y * 1; // ä¸Šä¸‹æ—‹è½¬å¹…åº¦
            }
        }

        const hands = new Hands({locateFile: (file) => {
            return `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`;
        }});
        
        hands.setOptions({
            maxNumHands: 1,
            modelComplexity: 1,
            minDetectionConfidence: 0.5,
            minTrackingConfidence: 0.5
        });
        
        hands.onResults(onResults);

        const cameraUtils = new Camera(videoElement, {
            onFrame: async () => {
                await hands.send({image: videoElement});
            },
            width: 640,
            height: 480
        });

        // --- 6. å¯åŠ¨é€»è¾‘ ---
        document.getElementById('start-btn').addEventListener('click', function() {
            document.getElementById('start-screen').style.display = 'none';
            document.getElementById('loading').style.display = 'block';
            
            // æ’­æ”¾èƒŒæ™¯éŸ³ä¹é€»è¾‘å¯ä»¥åœ¨è¿™é‡ŒåŠ 
            
            cameraUtils.start().then(() => {
                console.log("Camera started");
            }).catch(err => {
                console.error("Camera error:", err);
                alert("æ— æ³•å¯åŠ¨æ‘„åƒå¤´ï¼Œè¯·æ£€æŸ¥æƒé™ã€‚");
                document.getElementById('loading').innerText = "æ‘„åƒå¤´å¯åŠ¨å¤±è´¥";
            });
        });

        // çª—å£å¤§å°è°ƒæ•´
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>
</html>
